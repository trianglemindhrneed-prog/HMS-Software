@model HMSCore.Models.AppointmentViewModel

@{
    ViewData["Title"] = "Book Appointment";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<head>
    <link href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet" />
    <style>
        .btn-pink {
            background-color: #e83e8c !important;
            color: aliceblue !important;
        }

        .text-warning{
            color: red !important;
        }
    </style>
</head>

<div class="container mt-5">
    <h2>Book Appointment</h2>

    <div class="row mb-3">
        <div class="col-md-6">
            <label>Department</label>
            <select id="ddlDepartments" class="form-select">
                <option value="">Select Department</option>
                @foreach (var dep in Model.Departments)
                {
                    <option value="@dep.DepartmentId">@dep.DepartmentName</option>
                }
            </select>
        </div>
        <div class="col-md-6">
            <label>Doctor</label>
            <select id="ddlDoctors" class="form-select">
                <option value="">Select Doctor</option>
            </select>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6"> 
            <div id="calendar"></div>
        </div>
        <div class="col-md-6">
            <div id="slotsContainer" class="d-flex flex-wrap gap-2"></div>
        </div>
        </div> 
</div>
 
    <div id="bookingFormContainer" class="mt-4 row card third-row" style="display:none;">
    <div class="col-sm-12">
        <h4>Booking Details</h4></div>
        <!-- Hidden fields -->
    <input type="hidden" id="hdnSlotTime" />
    <input type="hidden" id="hdnBookingId" />
        <div class="col-sm-12">
        <input autocomplete="off" required type="text" id="txtName" class="form-control mb-2" placeholder="Name" />
    </div>
        <div class="col-sm-12">
        <input autocomplete="off" required type="text" id="txtPhone" maxlength="10"
               class="form-control mb-2"
               placeholder="Phone"
               oninput="this.value = this.value.replace(/[^0-9]/g, '')" />

        </div>
            <div class="col-sm-12">
        <input autocomplete="off" required type="text" id="txtEmail" class="form-control mb-2" placeholder="Email" />
            </div>
                <div class="col-sm-12">
        <textarea autocomplete="off" required id="txtMessage" class="form-control mb-2" placeholder="Message"></textarea>
                </div>
                    <div class="col-sm-12">

    <select id="ddlPayment" class="form-select mb-2">
        <option value="Offline">Offline</option>
        <option value="Online">Online</option>
    </select>
                        <div class="col-sm-12">
    <button id="btnBook" class="btn btn-primary">Book Appointment</button>
                            <div id="bookingMessage" class="mt-2"></div>
                        </div>
</div>
</div> 
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script>
    function isValidEmail(email) {
        var emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
        return emailRegex.test(email);
    }

    function isValidPhone(phone) {
        var phoneRegex = /^[0-9]{10}$/;  
        return phoneRegex.test(phone);
    }

    $("#btnBook").click(function () {
        var phone = $("#txtPhone").val().trim();
        var email = $("#txtEmail").val().trim();
        var name = $("#txtName").val().trim();

        // Clear previous messages
        $("#bookingMessage").html("");

        // Name validation
        if (name === "") {
            $("#bookingMessage").html('<span class="text-danger">⚠ Please enter your name</span>');
            return;
        }

        // Phone validation
        if (!isValidPhone(phone)) {
            $("#bookingMessage").html('<span class="text-danger">⚠ Enter valid 10-digit phone number</span>');
            return;
        }

        // Email validation
        if (!isValidEmail(email)) {
            $("#bookingMessage").html('<span class="text-danger">⚠ Enter a valid email address</span>');
            return;
        }

        // Proceed with your AJAX booking code
        var model = {
            SelectedDepartmentId: $("#ddlDepartments").val(),
            SelectedDoctorId: $("#ddlDoctors").val(),
            SelectedDate: $("#calendar").val(),
            SelectedSlot: $("#hdnSlotTime").val(),
            PatientName: name,
            Phone: phone,
            Email: email,
            Message: $("#txtMessage").val(),
            PaymentMode: $("#ddlPayment").val()
        };

        $.ajax({
            url: '/BookAppointment/BookAppointment',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(model),
            success: function(res){
                if(res.success){ 
                    var msg = "✅ Your appointment is booked successfully!\n\n" +
                              "Booking ID: " + res.bookingId + "\n" +
                              "Date: " + $("#calendar").val() + "\n" +
                              "Slot: " + $("#hdnSlotTime").val() + "\n\n" +
                              "Please check your email for details.";
                    alert(msg); 
                    location.reload();
                } else {
                    $("#bookingMessage").html('<span class="text-danger">⚠ ' + res.message + '</span>');
                }
            },
            error: function(xhr){
                $("#bookingMessage").html('<span class="text-danger">Error occurred: '+xhr.statusText+'</span>');
            }
        });

    });
</script>

    <script>
        $(function () {
            var selectedSlot = null;
            var selectedDate = getToday();

            // Initialize calendar
            $("#calendar").datepicker({
                minDate: 0,
                dateFormat: 'yy-mm-dd',
                defaultDate: selectedDate,
                onSelect: function(dateText) {
                    selectedDate = dateText;
                    loadSlots();
                }
            }).datepicker("setDate", selectedDate);

            // Department → Doctor dropdown
            $("#ddlDepartments").change(function () {
                var depId = $(this).val();
                $("#ddlDoctors").html('<option value="">Select Doctor</option>');
                if (depId) {
                    $.getJSON('/BookAppointment/GetDoctors?departmentId=' + depId, function (data) {
                        $.each(data, function (i, d) {
                            $("#ddlDoctors").append('<option value="' + d.doctorId + '">' + d.fullName + '</option>');
                        });
                    });
                }
            });

            $("#ddlDoctors").change(loadSlots);

            // Convert any time to minutes (12-hour or 24-hour)
            function parseTimeToMinutes(t) {
                if (!t) return 0;
                var hours, minutes;
                t = t.trim();
                if (t.toUpperCase().includes("AM") || t.toUpperCase().includes("PM")) {
                    var parts = t.match(/(\d+):(\d+) (\wM)/);
                    if (!parts) return 0;
                    hours = parseInt(parts[1], 10);
                    minutes = parseInt(parts[2], 10);
                    var meridian = parts[3].toUpperCase();
                    if (meridian === 'PM' && hours !== 12) hours += 12;
                    if (meridian === 'AM' && hours === 12) hours = 0;
                } else {
                    var parts24 = t.split(":");
                    hours = parseInt(parts24[0], 10);
                    minutes = parseInt(parts24[1], 10);
                }
                return hours * 60 + minutes;
            }

            // Convert 24-hour time to 12-hour display
            function to12HourFormat(t) {
                if (t.toUpperCase().includes("AM") || t.toUpperCase().includes("PM")) return t;
                var parts = t.split(":");
                var hh = parseInt(parts[0], 10);
                var mm = parts[1];
                var ampm = hh >= 12 ? 'PM' : 'AM';
                hh = hh % 12;
                if(hh === 0) hh = 12;
                return hh.toString().padStart(2,'0') + ':' + mm + ' ' + ampm;
            }

            // function loadSlots() {
            //     var docId = $("#ddlDoctors").val();
            //     if (!docId) {
            //         $("#slotsContainer").empty();
            //         $("#bookingFormContainer").hide();
            //         return;
            //     }

            //     $.getJSON('/BookAppointment/GetSchedules', { doctorId: docId, date: selectedDate }, function (data) {
            //         $("#slotsContainer").empty();
            //         $("#bookingFormContainer").hide();
            //         selectedSlot = null;

            //         if (data.error) { alert('Error loading slots: ' + data.message); return; }

            //         // Use a map to prevent duplicates and mark priority
            //         var slotMap = {}; // key = 24-hour time, value = type
            //         $.each(data.available, function(i, s){ slotMap[parseTo24Hour(s)] = 'available'; });
            //         $.each(data.timeout, function(i, s){ slotMap[parseTo24Hour(s)] = 'timeout'; });
            //         $.each(data.blocked, function(i, s){ slotMap[parseTo24Hour(s)] = 'blocked'; });
            //         $.each(data.booked, function(i, s){ slotMap[parseTo24Hour(s)] = 'booked'; }); // booked overrides others

            //         // Convert map to sorted array
            //         var allSlots = Object.keys(slotMap)
            //             .sort(function(a,b){ return parseTimeToMinutes(a) - parseTimeToMinutes(b); })
            //             .map(function(t){ return { time: t, type: slotMap[t] }; });

            //         // Render buttons
            //         $.each(allSlots, function(i, slot){
            //             var displayTime = to12HourFormat(slot.time);
            //             var btn = '';
            //             if(slot.type === 'available') btn = '<button class="btn slotBtn btn-success" data-slot="'+displayTime+'">'+displayTime+'</button>';
            //             if(slot.type === 'booked') btn = '<button class="btn btn-primary" disabled>'+displayTime+'</button>';
            //             if(slot.type === 'timeout') btn = '<button class="btn btn-pink" disabled>'+displayTime+'</button>';
            //             if(slot.type === 'blocked') btn = '<button class="btn btn-danger" disabled>'+displayTime+'</button>';
            //             $("#slotsContainer").append(btn);
            //         });
            //     });
            // }
                    function loadSlots() {
            var docId = $("#ddlDoctors").val();
            if (!docId) {
                $("#slotsContainer").empty();
                $("#bookingFormContainer").hide();
                return;
            }

            $.getJSON('/BookAppointment/GetSchedules', { doctorId: docId, date: selectedDate }, function (data) {
                $("#slotsContainer").empty();
                $("#bookingFormContainer").hide();
                selectedSlot = null;

                if (data.error) {
                    alert('Error loading slots: ' + data.message);
                    return;
                }

                // Combine all slots into a map
                var slotMap = {};
                $.each(data.available, function(i, s){ slotMap[parseTo24Hour(s)] = 'available'; });
                $.each(data.timeout, function(i, s){ slotMap[parseTo24Hour(s)] = 'timeout'; });
                $.each(data.blocked, function(i, s){ slotMap[parseTo24Hour(s)] = 'blocked'; });
                $.each(data.booked, function(i, s){ slotMap[parseTo24Hour(s)] = 'booked'; });

                var allSlots = Object.keys(slotMap)
                    .sort(function(a,b){ return parseTimeToMinutes(a) - parseTimeToMinutes(b); })
                    .map(function(t){ return { time: t, type: slotMap[t] }; });

                if (allSlots.length === 0) {
                    $("#slotsContainer").html('<div class="text-warning">⚠ No slots available on this date. Please choose another date.</div>');
                    return;
                }

                // Render buttons
                $.each(allSlots, function(i, slot){
                    var displayTime = to12HourFormat(slot.time);
                    var btn = '';
                    if(slot.type === 'available') btn = '<button class="btn slotBtn btn-success" data-slot="'+displayTime+'">'+displayTime+'</button>';
                    if(slot.type === 'booked') btn = '<button class="btn btn-primary" disabled>'+displayTime+'</button>';
                    if(slot.type === 'timeout') btn = '<button class="btn btn-pink" disabled>'+displayTime+'</button>';
                    if(slot.type === 'blocked') btn = '<button class="btn btn-danger" disabled>'+displayTime+'</button>';
                    $("#slotsContainer").append(btn);
                });
            });
        }

            function parseTo24Hour(t) {
                if (!t) return '';
                t = t.trim();
                if (t.toUpperCase().includes("AM") || t.toUpperCase().includes("PM")) {
                    var parts = t.match(/(\d+):(\d+) (\wM)/);
                    if (!parts) return '';
                    var hh = parseInt(parts[1], 10);
                    var mm = parts[2];
                    var meridian = parts[3].toUpperCase();
                    if (meridian === 'PM' && hh !== 12) hh += 12;
                    if (meridian === 'AM' && hh === 12) hh = 0;
                    return hh.toString().padStart(2,'0') + ':' + mm;
                } else return t;
            }

            // Slot click
            $(document).on('click', '.slotBtn.btn-success', function () {
                $(".slotBtn").removeClass('btn-outline-success').addClass('btn-success');
                $(this).removeClass('btn-success').addClass('btn-outline-success');
                selectedSlot = $(this).data('slot');
                $("#hdnSlotTime").val(selectedSlot);
                $("#bookingFormContainer").slideDown();
            });

            // Book appointment
        //     $("#btnBook").click(function() {
        //         if (!selectedSlot) { alert("Please select a slot!"); return; }

        //         var model = {
        //             SelectedDepartmentId: $("#ddlDepartments").val(),
        //             SelectedDoctorId: $("#ddlDoctors").val(),
        //             SelectedDate: selectedDate,
        //             SelectedSlot: selectedSlot,
        //             PatientName: $("#txtName").val(),
        //             Phone: $("#txtPhone").val(),
        //             Email: $("#txtEmail").val(),
        //             Message: $("#txtMessage").val(),
        //             PaymentMode: $("#ddlPayment").val()
        //         };

        //         $.ajax({
        //             url: '/BookAppointment/BookAppointment',
        //             type: 'POST',
        //             contentType: 'application/json',
        //             data: JSON.stringify(model),
        //             success: function(res){
        //                       if(res.success){ 
        //     var msg = "✅ Your appointment is booked successfully!\n\n" +
        //               "Booking ID: " + res.bookingId + "\n" +
        //               "Date: " + selectedDate + "\n" +
        //               "Slot: " + selectedSlot + "\n\n" +
        //               "Please check your email for details.";

        //     alert(msg); 
        //     location.reload();
        // } else {
        //     $("#bookingMessage").html('<span class="text-danger">⚠ ' + res.message + '</span>');
        // }

        //             },
        //             error: function(xhr){
        //                 $("#bookingMessage").html('<span class="text-danger">Error occurred: '+xhr.statusText+'</span>');
        //             }
        //         });
        //     });

            function getToday() {
                var today = new Date();
                var yyyy = today.getFullYear();
                var mm = today.getMonth() + 1;
                var dd = today.getDate();
                if (mm < 10) mm = '0' + mm;
                if (dd < 10) dd = '0' + dd;
                return yyyy + '-' + mm + '-' + dd;
            }
        });
    </script>
}


