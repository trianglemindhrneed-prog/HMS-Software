@model HMSCore.Areas.Admin.Models.AddCheckupViewModel
@using Newtonsoft.Json
@{
    ViewData["Title"] = "Add New Checkup";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
<head>
    <style>
        .page-btn {
            display: none;
        }
    </style>
</head>


<div class="content-wrapper" style="margin-left:10px;">
    <section class="content-header">
        <h1>Patient Checkup</h1>
    </section>

    <section class="content">
        <div class="box">
            <div class="box-body">

                <form asp-action="AddNewCheckup" method="post">

                    <input type="hidden" asp-for="PatientId" />

                    <h4 class="page-header">Checkup</h4>

                    <div class="row">

                        <!-- Doctor -->
                        <div class="form-group col-sm-4">
                            <label>Doctor <span class="text-danger">*</span></label>
                            <select asp-for="SelectedDoctorId" class="form-control">
                                <option value="">-- Select Doctor --</option>
                                @foreach (var d in Model.Doctors)
                                {
                                    <option value="@d.DoctorId">@d.FullName</option>
                                }
                            </select>
                            <span asp-validation-for="SelectedDoctorId" class="text-danger"></span>
                        </div>

                        <!-- Symptoms -->
                        <div class="form-group col-sm-4">
                            <label>Symptoms <span class="text-danger">*</span></label>
                            <textarea asp-for="Symptoms" class="form-control" rows="2"></textarea>
                            <span asp-validation-for="Symptoms" class="text-danger"></span>
                        </div>

                        <!-- Diagnosis -->
                        <div class="form-group col-sm-4">
                            <label>Diagnosis <span class="text-danger">*</span></label>
                            <textarea asp-for="Diagnosis" class="form-control" rows="2"></textarea>
                            <span asp-validation-for="Diagnosis" class="text-danger"></span>
                        </div>

                        <!-- Date -->
                        <div class="form-group col-sm-4">
                            <label>Checkup Date</label>
                            <input asp-for="CheckupDate" type="date" class="form-control" />
                        </div>

                    </div>

                    <hr />

                    <!-- PRESCRIPTION -->
                    <h4 class="page-header">Prescription</h4>

                    <table class="table table-bordered" id="tblMedicines">
                        <thead>
                            <tr>
                                <th>Medicine</th>
                                <th>No. of Days</th>
                                <th>When to Take</th>
                                <th>Before Meal?</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>

                    <button type="button" id="btnAddMedicine" class="btn btn-primary btn-sm">
                        Add Medicine
                    </button>

                    <hr />

                    <!-- Extra Notes -->
                    <div class="form-group">
                        <label>Extra Notes</label>
                        <textarea asp-for="ExtraNotes" class="form-control" rows="2"></textarea>
                    </div>

                    <br />

                    <button type="submit" class="btn btn-success">
                        Save Checkup
                    </button>

                </form>

            </div>
        </div>
    </section>
</div>

@section Scripts {

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
            // medicines from server
            var medicinesList = @Html.Raw(JsonConvert.SerializeObject(Model.Medicines));

            $("#btnAddMedicine").click(function () {
                addMedicineRow();
            });

            function addMedicineRow() {

                // IMPORTANT: sequential index for model binding
                let index = $("#tblMedicines tbody tr").length;

                let options = '<option value="">-- Select Medicine --</option>';
                medicinesList.forEach(function (m) {
                    options += `<option value="${m.MedicineId}">${m.Name}</option>`;
                });

                let row = `
        <tr>
            <td>
                <select name="Prescriptions[${index}].MedicineId" class="form-control">
                    ${options}
                </select>
            </td>
            <td>
                <input type="number" name="Prescriptions[${index}].NoOfDays"
                       class="form-control" value="0" />
            </td>
            <td>
                <select name="Prescriptions[${index}].WhenToTake" class="form-control">
                    <option value="">-- Select --</option>
                    <option value="1-1-1">1-1-1</option>
                    <option value="1-0-1">1-0-1</option>
                    <option value="0-1-0">0-1-0</option>
                    <option value="1-0-0">1-0-0</option>
                </select>
            </td>
            <td class="text-center">
                <input type="checkbox"
                       name="Prescriptions[${index}].IsBeforeMeal"
                       value="true" />
            </td>
            <td>
                <button type="button"
                        class="btn btn-danger btn-sm btnDeleteRow">
                    Delete
                </button>
            </td>
        </tr>`;

                $("#tblMedicines tbody").append(row);
            }

            $(document).on("click", ".btnDeleteRow", function () {
                $(this).closest("tr").remove();
                reIndexRows();
            });

            // reindex after delete (VERY IMPORTANT)
            function reIndexRows() {
                $("#tblMedicines tbody tr").each(function (i) {
                    $(this).find("select, input").each(function () {
                        let name = $(this).attr("name");
                        if (name) {
                            let newName = name.replace(/\[\d+\]/, "[" + i + "]");
                            $(this).attr("name", newName);
                        }
                    });
                });
            }
    </script>

}
